package com.example.shravan.techhome;

import android.app.ProgressDialog;
import android.content.Context;
import android.content.Intent;
import android.content.SharedPreferences;
import android.os.AsyncTask;
import android.os.Bundle;
import android.support.design.widget.FloatingActionButton;
import android.support.design.widget.Snackbar;
import android.support.v7.app.AppCompatActivity;
import android.support.v7.widget.Toolbar;
import android.view.View;
import android.view.Menu;
import android.view.MenuItem;
import android.widget.Button;
import android.widget.CheckBox;
import android.widget.EditText;
import android.widget.Toast;

import java.util.HashMap;

public class LoginPage extends AppCompatActivity implements View.OnClickListener{

    EditText username;
    EditText password;
    Button login;
    CheckBox remember;
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_login_page);

username=(EditText)findViewById(R.id.editTextUsername);
        password = (EditText) findViewById(R.id.editTextPassword);
        SharedPreferences sharedPref;

        Intent intent;
        login = (Button) findViewById(R.id.login);
        login.setOnClickListener(this);

        remember = (CheckBox) findViewById(R.id.checkBoxRememberMe);
        sharedPref = getSharedPreferences("users_info", Context.MODE_PRIVATE);
        Boolean sh = sharedPref.getBoolean("logged_in", false);
        String name=sharedPref.getString("username","");
        if (sh == true) {
            Toast.makeText(LoginPage.this, "Welcome "+name, Toast.LENGTH_LONG).show();


            intent = new Intent(this, Device_List.class);
            startActivity(intent);

        }
        }

    @Override
    public boolean onCreateOptionsMenu(Menu menu) {
        getMenuInflater().inflate(R.menu.menu_login_page, menu);
        return true;
    }



    private void checkDetails(){

        final String name =username.getText().toString().trim();
        final String pass = password.getText().toString().trim();

        class Login extends AsyncTask<Void,Void,String> {

            ProgressDialog loading;

            @Override
            protected void onPreExecute() {
                super.onPreExecute();
                loading = ProgressDialog.show(LoginPage.this,"Connecting To Server...","Wait...",false,false);
            }

            @Override
            protected void onPostExecute(String s) {
                super.onPostExecute(s);
                loading.dismiss();
                if (s.equals("yes")) {


                    Toast.makeText(LoginPage.this, "welcome "+name, Toast.LENGTH_LONG).show();
                    if (remember.isChecked()){

                        SharedPreferences sharedPref=getSharedPreferences("users_info", Context.MODE_PRIVATE);
                        SharedPreferences.Editor editor=sharedPref.edit();
                        editor.putString("username",name);
                        editor.putString("password",pass);
                        editor.putBoolean("logged_in",true);

                        editor.commit();



                    }
                    gotonext();
                }
                else {
                    Toast.makeText(LoginPage.this,"Incorrect Username or Password", Toast.LENGTH_LONG).show();

                }
            }

            @Override
            protected String doInBackground(Void... v) {
                HashMap<String,String> params = new HashMap<>();
                params.put(Config.KEY_USER_NAME,name);
                params.put(Config.KEY_USER_PASSWORD,pass);


                RequestHandler rh = new RequestHandler();
                String res = rh.sendPostRequest(Config.URL_CHECK, params);
                return res;
            }
        }

        Login cd = new Login();
        cd.execute();
    }













    @Override
    public boolean onOptionsItemSelected(MenuItem item) {
        int id = item.getItemId();

        if (id == R.id.action_settings) {
            return true;
        }

        return super.onOptionsItemSelected(item);
    }

    @Override
    public void onClick(View v) {


        checkDetails();


    }

    public void gotonext(){
        Intent  intent = new Intent(this,Device_List.class);
        startActivity(intent);



    }
}
